<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Non-Linear Modeling – MGMT 47400: Predictive Analytics</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Non-Linear Modeling</li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
      <a href="../../index.html" class="sidebar-logo-link">
      <img src="../../images/mgmt_474_ai_logo_02-modified.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      <div class="sidebar-tools-main">
    <a href="https://github.com/davi-moreira/2025S_predictive_analytics_purdue_MGMT474" title="GitHub" class="quarto-navigation-tool px-1" aria-label="GitHub"><i class="bi bi-github"></i></a>
</div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../syllabus.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Syllabus</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../schedule.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Schedule and Material</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#polynomial-regression-and-step-functions" id="toc-polynomial-regression-and-step-functions" class="nav-link active" data-scroll-target="#polynomial-regression-and-step-functions">Polynomial Regression and Step Functions</a></li>
  <li><a href="#splines" id="toc-splines" class="nav-link" data-scroll-target="#splines">Splines</a></li>
  <li><a href="#smoothing-splines-and-gams" id="toc-smoothing-splines-and-gams" class="nav-link" data-scroll-target="#smoothing-splines-and-gams">Smoothing Splines and GAMs</a>
  <ul class="collapse">
  <li><a href="#additive-models-with-several-terms" id="toc-additive-models-with-several-terms" class="nav-link" data-scroll-target="#additive-models-with-several-terms">Additive Models with Several Terms</a></li>
  <li><a href="#anova-tests-for-additive-models" id="toc-anova-tests-for-additive-models" class="nav-link" data-scroll-target="#anova-tests-for-additive-models">ANOVA Tests for Additive Models</a></li>
  </ul></li>
  <li><a href="#local-regression" id="toc-local-regression" class="nav-link" data-scroll-target="#local-regression">Local Regression</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Non-Linear Modeling</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><a target="_blank" href="https://colab.research.google.com/github/intro-stat-learning/ISLP_labs/blob/v2.2/Ch07-nonlin-lab.ipynb"> <img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"> </a></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="https://mybinder.org/v2/gh/intro-stat-learning/ISLP_labs/v2.2?labpath=Ch07-nonlin-lab.ipynb"><img src="https://mybinder.org/badge_logo.svg" class="img-fluid figure-img" alt="Binder"></a></p>
<figcaption>Binder</figcaption>
</figure>
</div>
<p>In this lab, we demonstrate some of the nonlinear models discussed in this chapter. We use the <code>Wage</code> data as a running example, and show that many of the complex non-linear fitting procedures discussed can easily be implemented in <code>Python</code>.</p>
<p>As usual, we start with some of our standard imports.</p>
<div id="4f8339f1" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:34.911110Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:34.910732Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:35.700317Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:35.700028Z&quot;}" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np, pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.pyplot <span class="im">import</span> subplots</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ISLP <span class="im">import</span> load_data</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ISLP.models <span class="im">import</span> (summarize,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>                         poly,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>                         ModelSpec <span class="im">as</span> MS)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.stats.anova <span class="im">import</span> anova_lm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We again collect the new imports needed for this lab. Many of these are developed specifically for the <code>ISLP</code> package.</p>
<div id="816d4b81" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:35.702094Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:35.701965Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:35.722229Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:35.722033Z&quot;}" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pygam <span class="im">import</span> (s <span class="im">as</span> s_gam,</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                   l <span class="im">as</span> l_gam,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                   f <span class="im">as</span> f_gam,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                   LinearGAM,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>                   LogisticGAM)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ISLP.transforms <span class="im">import</span> (BSpline,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>                             NaturalSpline)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ISLP.models <span class="im">import</span> bs, ns</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ISLP.pygam <span class="im">import</span> (approx_lam,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>                        degrees_of_freedom,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>                        plot <span class="im">as</span> plot_gam,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>                        anova <span class="im">as</span> anova_gam)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="polynomial-regression-and-step-functions" class="level2">
<h2 class="anchored" data-anchor-id="polynomial-regression-and-step-functions">Polynomial Regression and Step Functions</h2>
<p>We start by demonstrating how Figure~<span class="math inline">\(\ref{Ch7:fig:poly}\)</span> can be reproduced. Let’s begin by loading the data.</p>
<div id="bd30b197" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:35.723538Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:35.723455Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:35.730561Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:35.730367Z&quot;}" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>Wage <span class="op">=</span> load_data(<span class="st">'Wage'</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> Wage[<span class="st">'wage'</span>]</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>age <span class="op">=</span> Wage[<span class="st">'age'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Throughout most of this lab, our response is <code>Wage['wage']</code>, which we have stored as <code>y</code> above. As in Section~<span class="math inline">\(\ref{Ch3-linreg-lab:non-linear-transformations-of-the-predictors}\)</span>, we will use the <code>poly()</code> function to create a model matrix that will fit a <span class="math inline">\(4\)</span>th degree polynomial in <code>age</code>.</p>
<div id="fe40e0fb" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:35.731830Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:35.731745Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:35.758719Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:35.758161Z&quot;}" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>poly_age <span class="op">=</span> MS([poly(<span class="st">'age'</span>, degree<span class="op">=</span><span class="dv">4</span>)]).fit(Wage)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> sm.OLS(y, poly_age.transform(Wage)).fit()</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>summarize(M)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">coef</th>
<th data-quarto-table-cell-role="th">std err</th>
<th data-quarto-table-cell-role="th">t</th>
<th data-quarto-table-cell-role="th">P&gt;|t|</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">intercept</td>
<td>111.7036</td>
<td>0.729</td>
<td>153.283</td>
<td>0.000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">poly(age, degree=4)[0]</td>
<td>447.0679</td>
<td>39.915</td>
<td>11.201</td>
<td>0.000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">poly(age, degree=4)[1]</td>
<td>-478.3158</td>
<td>39.915</td>
<td>-11.983</td>
<td>0.000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">poly(age, degree=4)[2]</td>
<td>125.5217</td>
<td>39.915</td>
<td>3.145</td>
<td>0.002</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">poly(age, degree=4)[3]</td>
<td>-77.9112</td>
<td>39.915</td>
<td>-1.952</td>
<td>0.051</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>This polynomial is constructed using the function <code>poly()</code>, which creates a special <em>transformer</em> <code>Poly()</code> (using <code>sklearn</code> terminology for feature transformations such as <code>PCA()</code> seen in Section <span class="math inline">\(\ref{Ch6-varselect-lab:principal-components-regression}\)</span>) which allows for easy evaluation of the polynomial at new data points. Here <code>poly()</code> is referred to as a <em>helper</em> function, and sets up the transformation; <code>Poly()</code> is the actual workhorse that computes the transformation. See also the discussion of transformations on page~.</p>
<p>In the code above, the first line executes the <code>fit()</code> method using the dataframe <code>Wage</code>. This recomputes and stores as attributes any parameters needed by <code>Poly()</code> on the training data, and these will be used on all subsequent evaluations of the <code>transform()</code> method. For example, it is used on the second line, as well as in the plotting function developed below.</p>
<p>We now create a grid of values for <code>age</code> at which we want predictions.</p>
<div id="23a9ff8e" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:35.762173Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:35.761857Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:35.766441Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:35.765894Z&quot;}" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>age_grid <span class="op">=</span> np.linspace(age.<span class="bu">min</span>(),</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                       age.<span class="bu">max</span>(),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                       <span class="dv">100</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>age_df <span class="op">=</span> pd.DataFrame({<span class="st">'age'</span>: age_grid})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we wish to plot the data and add the fit from the fourth-degree polynomial. As we will make several similar plots below, we first write a function to create all the ingredients and produce the plot. Our function takes in a model specification (here a basis specified by a transform), as well as a grid of <code>age</code> values. The function produces a fitted curve as well as 95% confidence bands. By using an argument for <code>basis</code> we can produce and plot the results with several different transforms, such as the splines we will see shortly.</p>
<div id="ca7a1d45" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:35.771011Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:35.770581Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:35.776229Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:35.775762Z&quot;}" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_wage_fit(age_df, </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                  basis,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                  title):</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> basis.transform(Wage)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    Xnew <span class="op">=</span> basis.transform(age_df)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    M <span class="op">=</span> sm.OLS(y, X).fit()</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> M.get_prediction(Xnew)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    bands <span class="op">=</span> preds.conf_int(alpha<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    ax.scatter(age,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>               y,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>               facecolor<span class="op">=</span><span class="st">'gray'</span>,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>               alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> val, ls <span class="kw">in</span> <span class="bu">zip</span>([preds.predicted_mean,</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>                      bands[:,<span class="dv">0</span>],</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>                      bands[:,<span class="dv">1</span>]],</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>                     [<span class="st">'b'</span>,<span class="st">'r--'</span>,<span class="st">'r--'</span>]):</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        ax.plot(age_df.values, val, ls, linewidth<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    ax.set_title(title, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">'Age'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Wage'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ax</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We include an argument <code>alpha</code> to <code>ax.scatter()</code> to add some transparency to the points. This provides a visual indication of density. Notice the use of the <code>zip()</code> function in the <code>for</code> loop above (see Section~<span class="math inline">\(\ref{Ch2-statlearn-lab:for-loops}\)</span>). We have three lines to plot, each with different colors and line types. Here <code>zip()</code> conveniently bundles these together as iterators in the loop. {In <code>Python</code> speak, an “iterator” is an object with a finite number of values, that can be iterated on, as in a loop.}</p>
<p>We now plot the fit of the fourth-degree polynomial using this function.</p>
<div id="b05a60ba" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:35.779177Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:35.778961Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:36.009418Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:36.008910Z&quot;}" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>plot_wage_fit(age_df, </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>              poly_age,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>              <span class="st">'Degree-4 Polynomial'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="07-nonlin-lab_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>With polynomial regression we must decide on the degree of the polynomial to use. Sometimes we just wing it, and decide to use second or third degree polynomials, simply to obtain a nonlinear fit. But we can make such a decision in a more systematic way. One way to do this is through hypothesis tests, which we demonstrate here. We now fit a series of models ranging from linear (degree-one) to degree-five polynomials, and look to determine the simplest model that is sufficient to explain the relationship between <code>wage</code> and <code>age</code>. We use the <code>anova_lm()</code> function, which performs a series of ANOVA tests. An or ANOVA tests the null hypothesis that a model <span class="math inline">\(\mathcal{M}_1\)</span> is sufficient to explain the data against the alternative hypothesis that a more complex model <span class="math inline">\(\mathcal{M}_2\)</span> is required. The determination is based on an F-test. To perform the test, the models <span class="math inline">\(\mathcal{M}_1\)</span> and <span class="math inline">\(\mathcal{M}_2\)</span> must be <em>nested</em>: the space spanned by the predictors in <span class="math inline">\(\mathcal{M}_1\)</span> must be a subspace of the space spanned by the predictors in <span class="math inline">\(\mathcal{M}_2\)</span>. In this case, we fit five different polynomial models and sequentially compare the simpler model to the more complex model.</p>
<div id="c338a92a" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:36.012673Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:36.012313Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:36.072501Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:36.071990Z&quot;}" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> [MS([poly(<span class="st">'age'</span>, degree<span class="op">=</span>d)]) </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> d <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">6</span>)]</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>Xs <span class="op">=</span> [model.fit_transform(Wage) <span class="cf">for</span> model <span class="kw">in</span> models]</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>anova_lm(<span class="op">*</span>[sm.OLS(y, X_).fit()</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>           <span class="cf">for</span> X_ <span class="kw">in</span> Xs])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">df_resid</th>
<th data-quarto-table-cell-role="th">ssr</th>
<th data-quarto-table-cell-role="th">df_diff</th>
<th data-quarto-table-cell-role="th">ss_diff</th>
<th data-quarto-table-cell-role="th">F</th>
<th data-quarto-table-cell-role="th">Pr(&gt;F)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2998.0</td>
<td>5.022216e+06</td>
<td>0.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2997.0</td>
<td>4.793430e+06</td>
<td>1.0</td>
<td>228786.010128</td>
<td>143.593107</td>
<td>2.363850e-32</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2996.0</td>
<td>4.777674e+06</td>
<td>1.0</td>
<td>15755.693664</td>
<td>9.888756</td>
<td>1.679202e-03</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2995.0</td>
<td>4.771604e+06</td>
<td>1.0</td>
<td>6070.152124</td>
<td>3.809813</td>
<td>5.104620e-02</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2994.0</td>
<td>4.770322e+06</td>
<td>1.0</td>
<td>1282.563017</td>
<td>0.804976</td>
<td>3.696820e-01</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Notice the <code>*</code> in the <code>anova_lm()</code> line above. This function takes a variable number of non-keyword arguments, in this case fitted models. When these models are provided as a list (as is done here), it must be prefixed by <code>*</code>.</p>
<p>The p-value comparing the linear <code>models[0]</code> to the quadratic <code>models[1]</code> is essentially zero, indicating that a linear fit is not sufficient. {Indexing starting at zero is confusing for the polynomial degree example, since <code>models[1]</code> is quadratic rather than linear!} Similarly the p-value comparing the quadratic <code>models[1]</code> to the cubic <code>models[2]</code> is very low (0.0017), so the quadratic fit is also insufficient. The p-value comparing the cubic and degree-four polynomials, <code>models[2]</code> and <code>models[3]</code>, is approximately 5%, while the degree-five polynomial <code>models[4]</code> seems unnecessary because its p-value is 0.37. Hence, either a cubic or a quartic polynomial appear to provide a reasonable fit to the data, but lower- or higher-order models are not justified.</p>
<p>In this case, instead of using the <code>anova()</code> function, we could have obtained these p-values more succinctly by exploiting the fact that <code>poly()</code> creates orthogonal polynomials.</p>
<div id="a1f74b79" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:36.075597Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:36.075369Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:36.090416Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:36.089945Z&quot;}" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>summarize(M)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">coef</th>
<th data-quarto-table-cell-role="th">std err</th>
<th data-quarto-table-cell-role="th">t</th>
<th data-quarto-table-cell-role="th">P&gt;|t|</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">intercept</td>
<td>111.7036</td>
<td>0.729</td>
<td>153.283</td>
<td>0.000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">poly(age, degree=4)[0]</td>
<td>447.0679</td>
<td>39.915</td>
<td>11.201</td>
<td>0.000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">poly(age, degree=4)[1]</td>
<td>-478.3158</td>
<td>39.915</td>
<td>-11.983</td>
<td>0.000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">poly(age, degree=4)[2]</td>
<td>125.5217</td>
<td>39.915</td>
<td>3.145</td>
<td>0.002</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">poly(age, degree=4)[3]</td>
<td>-77.9112</td>
<td>39.915</td>
<td>-1.952</td>
<td>0.051</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Notice that the p-values are the same, and in fact the square of the t-statistics are equal to the F-statistics from the <code>anova_lm()</code> function; for example:</p>
<div id="570892d1" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:36.092926Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:36.092726Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:36.096105Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:36.095602Z&quot;}" data-execution_count="10">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>(<span class="op">-</span><span class="fl">11.983</span>)<span class="op">**</span><span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>143.59228900000002</code></pre>
</div>
</div>
<p>However, the ANOVA method works whether or not we used orthogonal polynomials, provided the models are nested. For example, we can use <code>anova_lm()</code> to compare the following three models, which all have a linear term in <code>education</code> and a polynomial in <code>age</code> of different degrees:</p>
<div id="3ff20916" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:36.098614Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:36.098427Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:36.147734Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:36.145914Z&quot;}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> [MS([<span class="st">'education'</span>, poly(<span class="st">'age'</span>, degree<span class="op">=</span>d)])</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> d <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">4</span>)]</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>XEs <span class="op">=</span> [model.fit_transform(Wage)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>       <span class="cf">for</span> model <span class="kw">in</span> models]</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>anova_lm(<span class="op">*</span>[sm.OLS(y, X_).fit() <span class="cf">for</span> X_ <span class="kw">in</span> XEs])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">df_resid</th>
<th data-quarto-table-cell-role="th">ssr</th>
<th data-quarto-table-cell-role="th">df_diff</th>
<th data-quarto-table-cell-role="th">ss_diff</th>
<th data-quarto-table-cell-role="th">F</th>
<th data-quarto-table-cell-role="th">Pr(&gt;F)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2997.0</td>
<td>3.902335e+06</td>
<td>0.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2996.0</td>
<td>3.759472e+06</td>
<td>1.0</td>
<td>142862.701185</td>
<td>113.991883</td>
<td>3.838075e-26</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2995.0</td>
<td>3.753546e+06</td>
<td>1.0</td>
<td>5926.207070</td>
<td>4.728593</td>
<td>2.974318e-02</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>As an alternative to using hypothesis tests and ANOVA, we could choose the polynomial degree using cross-validation, as discussed in Chapter~<span class="math inline">\(\ref{Ch5:resample}\)</span>.</p>
<p>Next we consider the task of predicting whether an individual earns more than $250,000 per year. We proceed much as before, except that first we create the appropriate response vector, and then apply the <code>glm()</code> function using the binomial family in order to fit a polynomial logistic regression model.</p>
<div id="2952bde3" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:36.154502Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:36.154251Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:36.179360Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:36.177817Z&quot;}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> poly_age.transform(Wage)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>high_earn <span class="op">=</span> Wage[<span class="st">'high_earn'</span>] <span class="op">=</span> y <span class="op">&gt;</span> <span class="dv">250</span> <span class="co"># shorthand</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>glm <span class="op">=</span> sm.GLM(y <span class="op">&gt;</span> <span class="dv">250</span>,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>             X,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>             family<span class="op">=</span>sm.families.Binomial())</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>B <span class="op">=</span> glm.fit()</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>summarize(B)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">coef</th>
<th data-quarto-table-cell-role="th">std err</th>
<th data-quarto-table-cell-role="th">z</th>
<th data-quarto-table-cell-role="th">P&gt;|z|</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">intercept</td>
<td>-4.3012</td>
<td>0.345</td>
<td>-12.457</td>
<td>0.000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">poly(age, degree=4)[0]</td>
<td>71.9642</td>
<td>26.133</td>
<td>2.754</td>
<td>0.006</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">poly(age, degree=4)[1]</td>
<td>-85.7729</td>
<td>35.929</td>
<td>-2.387</td>
<td>0.017</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">poly(age, degree=4)[2]</td>
<td>34.1626</td>
<td>19.697</td>
<td>1.734</td>
<td>0.083</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">poly(age, degree=4)[3]</td>
<td>-47.4008</td>
<td>24.105</td>
<td>-1.966</td>
<td>0.049</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Once again, we make predictions using the <code>get_prediction()</code> method.</p>
<div id="c999b609" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:36.182205Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:36.181928Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:36.188474Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:36.187832Z&quot;}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>newX <span class="op">=</span> poly_age.transform(age_df)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> B.get_prediction(newX)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>bands <span class="op">=</span> preds.conf_int(alpha<span class="op">=</span><span class="fl">0.05</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We now plot the estimated relationship.</p>
<div id="5f18a110" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:36.191550Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:36.191370Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:36.311190Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:36.310416Z&quot;}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.default_rng(<span class="dv">0</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>ax.scatter(age <span class="op">+</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>           <span class="fl">0.2</span> <span class="op">*</span> rng.uniform(size<span class="op">=</span>y.shape[<span class="dv">0</span>]),</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>           np.where(high_earn, <span class="fl">0.198</span>, <span class="fl">0.002</span>),</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>           fc<span class="op">=</span><span class="st">'gray'</span>,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>           marker<span class="op">=</span><span class="st">'|'</span>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> val, ls <span class="kw">in</span> <span class="bu">zip</span>([preds.predicted_mean,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>                  bands[:,<span class="dv">0</span>],</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>                  bands[:,<span class="dv">1</span>]],</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>                 [<span class="st">'b'</span>,<span class="st">'r--'</span>,<span class="st">'r--'</span>]):</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    ax.plot(age_df.values, val, ls, linewidth<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Degree-4 Polynomial'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Age'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>ax.set_ylim([<span class="dv">0</span>,<span class="fl">0.2</span>])</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'P(Wage &gt; 250)'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="07-nonlin-lab_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We have drawn the <code>age</code> values corresponding to the observations with <code>wage</code> values above 250 as gray marks on the top of the plot, and those with <code>wage</code> values below 250 are shown as gray marks on the bottom of the plot. We added a small amount of noise to jitter the <code>age</code> values a bit so that observations with the same <code>age</code> value do not cover each other up. This type of plot is often called a <em>rug plot</em>.</p>
<p>In order to fit a step function, as discussed in Section~<span class="math inline">\(\ref{Ch7:sec:scolstep-function}\)</span>, we first use the <code>pd.qcut()</code> function to discretize <code>age</code> based on quantiles. Then we use <code>pd.get_dummies()</code> to create the columns of the model matrix for this categorical variable. Note that this function will include <em>all</em> columns for a given categorical, rather than the usual approach which drops one of the levels.</p>
<div id="62e053ea" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:36.315065Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:36.314672Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:36.333569Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:36.333006Z&quot;}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>cut_age <span class="op">=</span> pd.qcut(age, <span class="dv">4</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>summarize(sm.OLS(y, pd.get_dummies(cut_age)).fit())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">coef</th>
<th data-quarto-table-cell-role="th">std err</th>
<th data-quarto-table-cell-role="th">t</th>
<th data-quarto-table-cell-role="th">P&gt;|t|</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">(17.999, 33.75]</td>
<td>94.1584</td>
<td>1.478</td>
<td>63.692</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">(33.75, 42.0]</td>
<td>116.6608</td>
<td>1.470</td>
<td>79.385</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">(42.0, 51.0]</td>
<td>119.1887</td>
<td>1.416</td>
<td>84.147</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">(51.0, 80.0]</td>
<td>116.5717</td>
<td>1.559</td>
<td>74.751</td>
<td>0.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Here <code>pd.qcut()</code> automatically picked the cutpoints based on the quantiles 25%, 50% and 75%, which results in four regions. We could also have specified our own quantiles directly instead of the argument <code>4</code>. For cuts not based on quantiles we would use the <code>pd.cut()</code> function. The function <code>pd.qcut()</code> (and <code>pd.cut()</code>) returns an ordered categorical variable. The regression model then creates a set of dummy variables for use in the regression. Since <code>age</code> is the only variable in the model, the value $94,158.40 is the average salary for those under 33.75 years of age, and the other coefficients are the average salary for those in the other age groups. We can produce predictions and plots just as we did in the case of the polynomial fit.</p>
</section>
<section id="splines" class="level2">
<h2 class="anchored" data-anchor-id="splines">Splines</h2>
<p>In order to fit regression splines, we use transforms from the <code>ISLP</code> package. The actual spline evaluation functions are in the <code>scipy.interpolate</code> package; we have simply wrapped them as transforms similar to <code>Poly()</code> and <code>PCA()</code>.</p>
<p>In Section~<span class="math inline">\(\ref{Ch7:sec:scolr-splin}\)</span>, we saw that regression splines can be fit by constructing an appropriate matrix of basis functions. The <code>BSpline()</code> function generates the entire matrix of basis functions for splines with the specified set of knots. By default, the B-splines produced are cubic. To change the degree, use the argument <code>degree</code>.</p>
<div id="f032f577" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:36.336489Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:36.336258Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:36.343862Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:36.343366Z&quot;}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>bs_ <span class="op">=</span> BSpline(internal_knots<span class="op">=</span>[<span class="dv">25</span>,<span class="dv">40</span>,<span class="dv">60</span>], intercept<span class="op">=</span><span class="va">True</span>).fit(age)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>bs_age <span class="op">=</span> bs_.transform(age)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>bs_age.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>(3000, 7)</code></pre>
</div>
</div>
<p>This results in a seven-column matrix, which is what is expected for a cubic-spline basis with 3 interior knots. We can form this same matrix using the <code>bs()</code> object, which facilitates adding this to a model-matrix builder (as in <code>poly()</code> versus its workhorse <code>Poly()</code>) described in Section~<span class="math inline">\(\ref{Ch7-nonlin-lab:polynomial-regression-and-step-functions}\)</span>.</p>
<p>We now fit a cubic spline model to the <code>Wage</code> data.</p>
<div id="c3c38823" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:36.346759Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:36.346545Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:36.380669Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:36.380119Z&quot;}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>bs_age <span class="op">=</span> MS([bs(<span class="st">'age'</span>, internal_knots<span class="op">=</span>[<span class="dv">25</span>,<span class="dv">40</span>,<span class="dv">60</span>])])</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>Xbs <span class="op">=</span> bs_age.fit_transform(Wage)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> sm.OLS(y, Xbs).fit()</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>summarize(M)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">coef</th>
<th data-quarto-table-cell-role="th">std err</th>
<th data-quarto-table-cell-role="th">t</th>
<th data-quarto-table-cell-role="th">P&gt;|t|</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">intercept</td>
<td>60.4937</td>
<td>9.460</td>
<td>6.394</td>
<td>0.000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">bs(age, internal_knots=[25, 40, 60])[0]</td>
<td>3.9805</td>
<td>12.538</td>
<td>0.317</td>
<td>0.751</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">bs(age, internal_knots=[25, 40, 60])[1]</td>
<td>44.6310</td>
<td>9.626</td>
<td>4.636</td>
<td>0.000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">bs(age, internal_knots=[25, 40, 60])[2]</td>
<td>62.8388</td>
<td>10.755</td>
<td>5.843</td>
<td>0.000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">bs(age, internal_knots=[25, 40, 60])[3]</td>
<td>55.9908</td>
<td>10.706</td>
<td>5.230</td>
<td>0.000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">bs(age, internal_knots=[25, 40, 60])[4]</td>
<td>50.6881</td>
<td>14.402</td>
<td>3.520</td>
<td>0.000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">bs(age, internal_knots=[25, 40, 60])[5]</td>
<td>16.6061</td>
<td>19.126</td>
<td>0.868</td>
<td>0.385</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The column names are a little cumbersome, and have caused us to truncate the printed summary. They can be set on construction using the <code>name</code> argument as follows.</p>
<div id="d01c2c26" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:36.384846Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:36.384459Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:36.418050Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:36.415940Z&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>bs_age <span class="op">=</span> MS([bs(<span class="st">'age'</span>,</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>                internal_knots<span class="op">=</span>[<span class="dv">25</span>,<span class="dv">40</span>,<span class="dv">60</span>],</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>                name<span class="op">=</span><span class="st">'bs(age)'</span>)])</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>Xbs <span class="op">=</span> bs_age.fit_transform(Wage)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> sm.OLS(y, Xbs).fit()</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>summarize(M)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">coef</th>
<th data-quarto-table-cell-role="th">std err</th>
<th data-quarto-table-cell-role="th">t</th>
<th data-quarto-table-cell-role="th">P&gt;|t|</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">intercept</td>
<td>60.4937</td>
<td>9.460</td>
<td>6.394</td>
<td>0.000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">bs(age)[0]</td>
<td>3.9805</td>
<td>12.538</td>
<td>0.317</td>
<td>0.751</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">bs(age)[1]</td>
<td>44.6310</td>
<td>9.626</td>
<td>4.636</td>
<td>0.000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">bs(age)[2]</td>
<td>62.8388</td>
<td>10.755</td>
<td>5.843</td>
<td>0.000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">bs(age)[3]</td>
<td>55.9908</td>
<td>10.706</td>
<td>5.230</td>
<td>0.000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">bs(age)[4]</td>
<td>50.6881</td>
<td>14.402</td>
<td>3.520</td>
<td>0.000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">bs(age)[5]</td>
<td>16.6061</td>
<td>19.126</td>
<td>0.868</td>
<td>0.385</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Notice that there are 6 spline coefficients rather than 7. This is because, by default, <code>bs()</code> assumes <code>intercept=False</code>, since we typically have an overall intercept in the model. So it generates the spline basis with the given knots, and then discards one of the basis functions to account for the intercept.</p>
<p>We could also use the <code>df</code> (degrees of freedom) option to specify the complexity of the spline. We see above that with 3 knots, the spline basis has 6 columns or degrees of freedom. When we specify <code>df=6</code> rather than the actual knots, <code>bs()</code> will produce a spline with 3 knots chosen at uniform quantiles of the training data. We can see these chosen knots most easily using <code>Bspline()</code> directly:</p>
<div id="672d44ae" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:36.421424Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:36.421207Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:36.429792Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:36.429086Z&quot;}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>BSpline(df<span class="op">=</span><span class="dv">6</span>).fit(age).internal_knots_</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>array([33.75, 42.  , 51.  ])</code></pre>
</div>
</div>
<p>When asking for six degrees of freedom, the transform chooses knots at ages 33.75, 42.0, and 51.0, which correspond to the 25th, 50th, and 75th percentiles of <code>age</code>.</p>
<p>When using B-splines we need not limit ourselves to cubic polynomials (i.e.&nbsp;<code>degree=3</code>). For instance, using <code>degree=0</code> results in piecewise constant functions, as in our example with <code>pd.qcut()</code> above.</p>
<div id="4a3f93ee" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:36.432272Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:36.432078Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:36.457934Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:36.457375Z&quot;}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>bs_age0 <span class="op">=</span> MS([bs(<span class="st">'age'</span>,</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>                 df<span class="op">=</span><span class="dv">3</span>, </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                 degree<span class="op">=</span><span class="dv">0</span>)]).fit(Wage)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>Xbs0 <span class="op">=</span> bs_age0.transform(Wage)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>summarize(sm.OLS(y, Xbs0).fit())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">coef</th>
<th data-quarto-table-cell-role="th">std err</th>
<th data-quarto-table-cell-role="th">t</th>
<th data-quarto-table-cell-role="th">P&gt;|t|</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">intercept</td>
<td>94.1584</td>
<td>1.478</td>
<td>63.687</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">bs(age, df=3, degree=0)[0]</td>
<td>22.3490</td>
<td>2.152</td>
<td>10.388</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">bs(age, df=3, degree=0)[1]</td>
<td>24.8076</td>
<td>2.044</td>
<td>12.137</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">bs(age, df=3, degree=0)[2]</td>
<td>22.7814</td>
<td>2.087</td>
<td>10.917</td>
<td>0.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>This fit should be compared with cell [15] where we use <code>qcut()</code> to create four bins by cutting at the 25%, 50% and 75% quantiles of <code>age</code>. Since we specified <code>df=3</code> for degree-zero splines here, there will also be knots at the same three quantiles. Although the coefficients appear different, we see that this is a result of the different coding. For example, the first coefficient is identical in both cases, and is the mean response in the first bin. For the second coefficient, we have <span class="math inline">\(94.158 + 22.349 = 116.507 \approx 116.611\)</span>, the latter being the mean in the second bin in cell [15]. Here the intercept is coded by a column of ones, so the second, third and fourth coefficients are increments for those bins. Why is the sum not exactly the same? It turns out that the <code>qcut()</code> uses <span class="math inline">\(\leq\)</span>, while <code>bs()</code> uses <span class="math inline">\(&lt;\)</span> when deciding bin membership.</p>
<p>In order to fit a natural spline, we use the <code>NaturalSpline()</code> transform with the corresponding helper <code>ns()</code>. Here we fit a natural spline with five degrees of freedom (excluding the intercept) and plot the results.</p>
<div id="bd2b4215" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:36.460525Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:36.460295Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:36.489739Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:36.489248Z&quot;}" data-execution_count="21">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>ns_age <span class="op">=</span> MS([ns(<span class="st">'age'</span>, df<span class="op">=</span><span class="dv">5</span>)]).fit(Wage)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>M_ns <span class="op">=</span> sm.OLS(y, ns_age.transform(Wage)).fit()</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>summarize(M_ns)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">coef</th>
<th data-quarto-table-cell-role="th">std err</th>
<th data-quarto-table-cell-role="th">t</th>
<th data-quarto-table-cell-role="th">P&gt;|t|</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">intercept</td>
<td>60.4752</td>
<td>4.708</td>
<td>12.844</td>
<td>0.000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">ns(age, df=5)[0]</td>
<td>61.5267</td>
<td>4.709</td>
<td>13.065</td>
<td>0.000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">ns(age, df=5)[1]</td>
<td>55.6912</td>
<td>5.717</td>
<td>9.741</td>
<td>0.000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">ns(age, df=5)[2]</td>
<td>46.8184</td>
<td>4.948</td>
<td>9.463</td>
<td>0.000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">ns(age, df=5)[3]</td>
<td>83.2036</td>
<td>11.918</td>
<td>6.982</td>
<td>0.000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">ns(age, df=5)[4]</td>
<td>6.8770</td>
<td>9.484</td>
<td>0.725</td>
<td>0.468</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We now plot the natural spline using our plotting function.</p>
<div id="9162a058" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:36.493122Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:36.492786Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:36.668184Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:36.667651Z&quot;}" data-execution_count="22">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>plot_wage_fit(age_df,</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>              ns_age,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>              <span class="st">'Natural spline, df=5'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="07-nonlin-lab_files/figure-html/cell-23-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="smoothing-splines-and-gams" class="level2">
<h2 class="anchored" data-anchor-id="smoothing-splines-and-gams">Smoothing Splines and GAMs</h2>
<p>A smoothing spline is a special case of a GAM with squared-error loss and a single feature. To fit GAMs in <code>Python</code> we will use the <code>pygam</code> package which can be installed via <code>pip install pygam</code>. The estimator <code>LinearGAM()</code> uses squared-error loss. The GAM is specified by associating each column of a model matrix with a particular smoothing operation: <code>s</code> for smoothing spline; <code>l</code> for linear, and <code>f</code> for factor or categorical variables. The argument <code>0</code> passed to <code>s</code> below indicates that this smoother will apply to the first column of a feature matrix. Below, we pass it a matrix with a single column: <code>X_age</code>. The argument <code>lam</code> is the penalty parameter <span class="math inline">\(\lambda\)</span> as discussed in Section~<span class="math inline">\(\ref{Ch7:sec5.2}\)</span>.</p>
<div id="86ff9343" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:36.671284Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:36.671050Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:36.705757Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:36.705247Z&quot;}" data-execution_count="23">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>X_age <span class="op">=</span> np.asarray(age).reshape((<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>gam <span class="op">=</span> LinearGAM(s_gam(<span class="dv">0</span>, lam<span class="op">=</span><span class="fl">0.6</span>))</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>gam.fit(X_age, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>LinearGAM(callbacks=[Deviance(), Diffs()], fit_intercept=True, 
   max_iter=100, scale=None, terms=s(0) + intercept, tol=0.0001, 
   verbose=False)</code></pre>
</div>
</div>
<p>The <code>pygam</code> library generally expects a matrix of features so we reshape <code>age</code> to be a matrix (a two-dimensional array) instead of a vector (i.e.&nbsp;a one-dimensional array). The <code>-1</code> in the call to the <code>reshape()</code> method tells <code>numpy</code> to impute the size of that dimension based on the remaining entries of the shape tuple.</p>
<p>Let’s investigate how the fit changes with the smoothing parameter <code>lam</code>. The function <code>np.logspace()</code> is similar to <code>np.linspace()</code> but spaces points evenly on the log-scale. Below we vary <code>lam</code> from <span class="math inline">\(10^{-2}\)</span> to <span class="math inline">\(10^6\)</span>.</p>
<div id="44812968" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:36.708880Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:36.708673Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:36.976882Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:36.976289Z&quot;}" data-execution_count="24">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>ax.scatter(age, y, facecolor<span class="op">=</span><span class="st">'gray'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> lam <span class="kw">in</span> np.logspace(<span class="op">-</span><span class="dv">2</span>, <span class="dv">6</span>, <span class="dv">5</span>):</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    gam <span class="op">=</span> LinearGAM(s_gam(<span class="dv">0</span>, lam<span class="op">=</span>lam)).fit(X_age, y)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    ax.plot(age_grid,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>            gam.predict(age_grid),</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">'</span><span class="sc">{:.1e}</span><span class="st">'</span>.<span class="bu">format</span>(lam),</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>            linewidth<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Age'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Wage'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>ax.legend(title<span class="op">=</span><span class="st">'$\lambda$'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="07-nonlin-lab_files/figure-html/cell-25-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The <code>pygam</code> package can perform a search for an optimal smoothing parameter.</p>
<div id="968e1e42" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:36.979615Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:36.979395Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:37.195601Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:37.195005Z&quot;}" data-execution_count="25">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>gam_opt <span class="op">=</span> gam.gridsearch(X_age, y)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>ax.plot(age_grid,</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>        gam_opt.predict(age_grid),</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">'Grid search'</span>,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>        linewidth<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>fig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>  0% (0 of 11) |                         | Elapsed Time: 0:00:00 ETA:  --:--:-- 45% (5 of 11) |###########              | Elapsed Time: 0:00:00 ETA:   0:00:00100% (11 of 11) |########################| Elapsed Time: 0:00:00 Time:  0:00:00</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="25">
<div>
<figure class="figure">
<p><img src="07-nonlin-lab_files/figure-html/cell-26-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Alternatively, we can fix the degrees of freedom of the smoothing spline using a function included in the <code>ISLP.pygam</code> package. Below we find a value of <span class="math inline">\(\lambda\)</span> that gives us roughly four degrees of freedom. We note here that these degrees of freedom include the unpenalized intercept and linear term of the smoothing spline, hence there are at least two degrees of freedom.</p>
<div id="891e3b75" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:37.198482Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:37.198260Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:37.214885Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:37.214249Z&quot;}" data-execution_count="26">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>age_term <span class="op">=</span> gam.terms[<span class="dv">0</span>]</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>lam_4 <span class="op">=</span> approx_lam(X_age, age_term, <span class="dv">4</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>age_term.lam <span class="op">=</span> lam_4</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>degrees_of_freedom(X_age, age_term)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>4.000000100001664</code></pre>
</div>
</div>
<p>Let’s vary the degrees of freedom in a similar plot to above. We choose the degrees of freedom as the desired degrees of freedom plus one to account for the fact that these smoothing splines always have an intercept term. Hence, a value of one for <code>df</code> is just a linear fit.</p>
<div id="54715029" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:37.218081Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:37.217683Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:37.501731Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:37.500504Z&quot;}" data-execution_count="27">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>ax.scatter(X_age,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>           y,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>           facecolor<span class="op">=</span><span class="st">'gray'</span>,</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>           alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> df <span class="kw">in</span> [<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">8</span>,<span class="dv">15</span>]:</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    lam <span class="op">=</span> approx_lam(X_age, age_term, df<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    age_term.lam <span class="op">=</span> lam</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    gam.fit(X_age, y)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    ax.plot(age_grid,</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>            gam.predict(age_grid),</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">'</span><span class="sc">{:d}</span><span class="st">'</span>.<span class="bu">format</span>(df),</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>            linewidth<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Age'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Wage'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>ax.legend(title<span class="op">=</span><span class="st">'Degrees of freedom'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="07-nonlin-lab_files/figure-html/cell-28-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="additive-models-with-several-terms" class="level3">
<h3 class="anchored" data-anchor-id="additive-models-with-several-terms">Additive Models with Several Terms</h3>
<p>The strength of generalized additive models lies in their ability to fit multivariate regression models with more flexibility than linear models. We demonstrate two approaches: the first in a more manual fashion using natural splines and piecewise constant functions, and the second using the <code>pygam</code> package and smoothing splines.</p>
<p>We now fit a GAM by hand to predict <code>wage</code> using natural spline functions of <code>year</code> and <code>age</code>, treating <code>education</code> as a qualitative predictor, as in (<span class="math inline">\(\ref{Ch7:nsmod}\)</span>). Since this is just a big linear regression model using an appropriate choice of basis functions, we can simply do this using the <code>sm.OLS()</code> function.</p>
<p>We will build the model matrix in a more manual fashion here, since we wish to access the pieces separately when constructing partial dependence plots.</p>
<div id="b3cd8b66" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:37.505073Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:37.504839Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:37.519804Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:37.519297Z&quot;}" data-execution_count="28">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>ns_age <span class="op">=</span> NaturalSpline(df<span class="op">=</span><span class="dv">4</span>).fit(age)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>ns_year <span class="op">=</span> NaturalSpline(df<span class="op">=</span><span class="dv">5</span>).fit(Wage[<span class="st">'year'</span>])</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>Xs <span class="op">=</span> [ns_age.transform(age),</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>      ns_year.transform(Wage[<span class="st">'year'</span>]),</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>      pd.get_dummies(Wage[<span class="st">'education'</span>]).values]</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>X_bh <span class="op">=</span> np.hstack(Xs)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>gam_bh <span class="op">=</span> sm.OLS(y, X_bh).fit()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here the function <code>NaturalSpline()</code> is the workhorse supporting the <code>ns()</code> helper function. We chose to use all columns of the indicator matrix for the categorical variable <code>education</code>, making an intercept redundant. Finally, we stacked the three component matrices horizontally to form the model matrix <code>X_bh</code>.</p>
<p>We now show how to construct partial dependence plots for each of the terms in our rudimentary GAM. We can do this by hand, given grids for <code>age</code> and <code>year</code>. We simply predict with new <span class="math inline">\(X\)</span> matrices, fixing all but one of the features at a time.</p>
<div id="ea8d6bc5" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:37.523112Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:37.522834Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:37.644337Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:37.643251Z&quot;}" data-execution_count="29">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>age_grid <span class="op">=</span> np.linspace(age.<span class="bu">min</span>(),</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>                       age.<span class="bu">max</span>(),</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>                       <span class="dv">100</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>X_age_bh <span class="op">=</span> X_bh.copy()[:<span class="dv">100</span>]</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>X_age_bh[:] <span class="op">=</span> X_bh[:].mean(<span class="dv">0</span>)[<span class="va">None</span>,:]</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>X_age_bh[:,:<span class="dv">4</span>] <span class="op">=</span> ns_age.transform(age_grid)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> gam_bh.get_prediction(X_age_bh)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>bounds_age <span class="op">=</span> preds.conf_int(alpha<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>partial_age <span class="op">=</span> preds.predicted_mean</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>center <span class="op">=</span> partial_age.mean()</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>partial_age <span class="op">-=</span> center</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>bounds_age <span class="op">-=</span> center</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>ax.plot(age_grid, partial_age, <span class="st">'b'</span>, linewidth<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>ax.plot(age_grid, bounds_age[:,<span class="dv">0</span>], <span class="st">'r--'</span>, linewidth<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>ax.plot(age_grid, bounds_age[:,<span class="dv">1</span>], <span class="st">'r--'</span>, linewidth<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Age'</span>)</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Effect on wage'</span>)</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Partial dependence of age on wage'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="07-nonlin-lab_files/figure-html/cell-30-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Let’s explain in some detail what we did above. The idea is to create a new prediction matrix, where all but the columns belonging to <code>age</code> are constant (and set to their training-data means). The four columns for <code>age</code> are filled in with the natural spline basis evaluated at the 100 values in <code>age_grid</code>.</p>
<ul>
<li>We made a grid of length 100 in <code>age</code>, and created a matrix <code>X_age_bh</code> with 100 rows and the same number of columns as <code>X_bh</code>.</li>
<li>We replaced every row of this matrix with the column means of the original.</li>
<li>We then replace just the first four columns representing <code>age</code> with the natural spline basis computed at the values in <code>age_grid</code>.</li>
</ul>
<p>The remaining steps should by now be familiar.</p>
<p>We also look at the effect of <code>year</code> on <code>wage</code>; the process is the same.</p>
<div id="812a47a1" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:37.648530Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:37.647173Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:37.756140Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:37.755581Z&quot;}" data-execution_count="30">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>year_grid <span class="op">=</span> np.linspace(<span class="dv">2003</span>, <span class="dv">2009</span>, <span class="dv">100</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>year_grid <span class="op">=</span> np.linspace(Wage[<span class="st">'year'</span>].<span class="bu">min</span>(),</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>                        Wage[<span class="st">'year'</span>].<span class="bu">max</span>(),</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>                        <span class="dv">100</span>)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>X_year_bh <span class="op">=</span> X_bh.copy()[:<span class="dv">100</span>]</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>X_year_bh[:] <span class="op">=</span> X_bh[:].mean(<span class="dv">0</span>)[<span class="va">None</span>,:]</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>X_year_bh[:,<span class="dv">4</span>:<span class="dv">9</span>] <span class="op">=</span> ns_year.transform(year_grid)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> gam_bh.get_prediction(X_year_bh)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>bounds_year <span class="op">=</span> preds.conf_int(alpha<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>partial_year <span class="op">=</span> preds.predicted_mean</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>center <span class="op">=</span> partial_year.mean()</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>partial_year <span class="op">-=</span> center</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>bounds_year <span class="op">-=</span> center</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>ax.plot(year_grid, partial_year, <span class="st">'b'</span>, linewidth<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>ax.plot(year_grid, bounds_year[:,<span class="dv">0</span>], <span class="st">'r--'</span>, linewidth<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>ax.plot(year_grid, bounds_year[:,<span class="dv">1</span>], <span class="st">'r--'</span>, linewidth<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Year'</span>)</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Effect on wage'</span>)</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Partial dependence of year on wage'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="07-nonlin-lab_files/figure-html/cell-31-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We now fit the model (<span class="math inline">\(\ref{Ch7:nsmod}\)</span>) using smoothing splines rather than natural splines. All of the terms in (<span class="math inline">\(\ref{Ch7:nsmod}\)</span>) are fit simultaneously, taking each other into account to explain the response. The <code>pygam</code> package only works with matrices, so we must convert the categorical series <code>education</code> to its array representation, which can be found with the <code>cat.codes</code> attribute of <code>education</code>. As <code>year</code> only has 7 unique values, we use only seven basis functions for it.</p>
<div id="88ff3def" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:37.759390Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:37.759130Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:37.788899Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:37.788370Z&quot;}" data-execution_count="31">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>gam_full <span class="op">=</span> LinearGAM(s_gam(<span class="dv">0</span>) <span class="op">+</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>                     s_gam(<span class="dv">1</span>, n_splines<span class="op">=</span><span class="dv">7</span>) <span class="op">+</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>                     f_gam(<span class="dv">2</span>, lam<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>Xgam <span class="op">=</span> np.column_stack([age,</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>                        Wage[<span class="st">'year'</span>],</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>                        Wage[<span class="st">'education'</span>].cat.codes])</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>gam_full <span class="op">=</span> gam_full.fit(Xgam, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The two <code>s_gam()</code> terms result in smoothing spline fits, and use a default value for <span class="math inline">\(\lambda\)</span> (<code>lam=0.6</code>), which is somewhat arbitrary. For the categorical term <code>education</code>, specified using a <code>f_gam()</code> term, we specify <code>lam=0</code> to avoid any shrinkage. We produce the partial dependence plot in <code>age</code> to see the effect of these choices.</p>
<p>The values for the plot are generated by the <code>pygam</code> package. We provide a <code>plot_gam()</code> function for partial-dependence plots in <code>ISLP.pygam</code>, which makes this job easier than in our last example with natural splines.</p>
<div id="29dbc933" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:37.792129Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:37.791875Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:37.909465Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:37.908764Z&quot;}" data-execution_count="32">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>plot_gam(gam_full, <span class="dv">0</span>, ax<span class="op">=</span>ax)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Age'</span>)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Effect on wage'</span>)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Partial dependence of age on wage - default lam=0.6'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="07-nonlin-lab_files/figure-html/cell-33-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We see that the function is somewhat wiggly. It is more natural to specify the <code>df</code> than a value for <code>lam</code>. We refit a GAM using four degrees of freedom each for <code>age</code> and <code>year</code>. Recall that the addition of one below takes into account the intercept of the smoothing spline.</p>
<div id="cdb535b5" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:37.912957Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:37.912683Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:37.946458Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:37.945953Z&quot;}" data-execution_count="33">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>age_term <span class="op">=</span> gam_full.terms[<span class="dv">0</span>]</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>age_term.lam <span class="op">=</span> approx_lam(Xgam, age_term, df<span class="op">=</span><span class="dv">4</span><span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>year_term <span class="op">=</span> gam_full.terms[<span class="dv">1</span>]</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>year_term.lam <span class="op">=</span> approx_lam(Xgam, year_term, df<span class="op">=</span><span class="dv">4</span><span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>gam_full <span class="op">=</span> gam_full.fit(Xgam, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that updating <code>age_term.lam</code> above updates it in <code>gam_full.terms[0]</code> as well! Likewise for <code>year_term.lam</code>.</p>
<p>Repeating the plot for <code>age</code>, we see that it is much smoother. We also produce the plot for <code>year</code>.</p>
<div id="2acadc27" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:37.950913Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:37.950529Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:38.082439Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:38.081725Z&quot;}" data-execution_count="34">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>plot_gam(gam_full,</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>         <span class="dv">1</span>,</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>         ax<span class="op">=</span>ax)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Year'</span>)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Effect on wage'</span>)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Partial dependence of year on wage'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>Text(0.5, 1.0, 'Partial dependence of year on wage')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="07-nonlin-lab_files/figure-html/cell-35-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Finally we plot <code>education</code>, which is categorical. The partial dependence plot is different, and more suitable for the set of fitted constants for each level of this variable.</p>
<div id="a2b8e481" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:38.085348Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:38.085138Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:38.186025Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:38.185091Z&quot;}" data-execution_count="35">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> plot_gam(gam_full, <span class="dv">2</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Education'</span>)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Effect on wage'</span>)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Partial dependence of wage on education'</span>,</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>             fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(Wage[<span class="st">'education'</span>].cat.categories, fontsize<span class="op">=</span><span class="dv">8</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="07-nonlin-lab_files/figure-html/cell-36-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="anova-tests-for-additive-models" class="level3">
<h3 class="anchored" data-anchor-id="anova-tests-for-additive-models">ANOVA Tests for Additive Models</h3>
<p>In all of our models, the function of <code>year</code> looks rather linear. We can perform a series of ANOVA tests in order to determine which of these three models is best: a GAM that excludes <code>year</code> (<span class="math inline">\(\mathcal{M}_1\)</span>), a GAM that uses a linear function of <code>year</code> (<span class="math inline">\(\mathcal{M}_2\)</span>), or a GAM that uses a spline function of <code>year</code> (<span class="math inline">\(\mathcal{M}_3\)</span>).</p>
<div id="1a76b516" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:38.189290Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:38.188978Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:38.226707Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:38.226124Z&quot;}" data-execution_count="36">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>gam_0 <span class="op">=</span> LinearGAM(age_term <span class="op">+</span> f_gam(<span class="dv">2</span>, lam<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>gam_0.fit(Xgam, y)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>gam_linear <span class="op">=</span> LinearGAM(age_term <span class="op">+</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>                       l_gam(<span class="dv">1</span>, lam<span class="op">=</span><span class="dv">0</span>) <span class="op">+</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>                       f_gam(<span class="dv">2</span>, lam<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>gam_linear.fit(Xgam, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>LinearGAM(callbacks=[Deviance(), Diffs()], fit_intercept=True, 
   max_iter=100, scale=None, terms=s(0) + l(1) + f(2) + intercept, 
   tol=0.0001, verbose=False)</code></pre>
</div>
</div>
<p>Notice our use of <code>age_term</code> in the expressions above. We do this because earlier we set the value for <code>lam</code> in this term to achieve four degrees of freedom.</p>
<p>To directly assess the effect of <code>year</code> we run an ANOVA on the three models fit above.</p>
<div id="7a68bf04" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:38.229152Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:38.228941Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:38.236919Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:38.236171Z&quot;}" data-execution_count="37">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>anova_gam(gam_0, gam_linear, gam_full)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">deviance</th>
<th data-quarto-table-cell-role="th">df</th>
<th data-quarto-table-cell-role="th">deviance_diff</th>
<th data-quarto-table-cell-role="th">df_diff</th>
<th data-quarto-table-cell-role="th">F</th>
<th data-quarto-table-cell-role="th">pvalue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>3.714362e+06</td>
<td>2991.004005</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>3.696746e+06</td>
<td>2990.005190</td>
<td>17616.542840</td>
<td>0.998815</td>
<td>14.265131</td>
<td>0.002314</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3.693143e+06</td>
<td>2987.007254</td>
<td>3602.893655</td>
<td>2.997936</td>
<td>0.972007</td>
<td>0.435579</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We find that there is compelling evidence that a GAM with a linear function in <code>year</code> is better than a GAM that does not include <code>year</code> at all (<span class="math inline">\(p\)</span>-value= 0.002). However, there is no evidence that a non-linear function of <code>year</code> is needed (<span class="math inline">\(p\)</span>-value=0.435). In other words, based on the results of this ANOVA, <span class="math inline">\(\mathcal{M}_2\)</span> is preferred.</p>
<p>We can repeat the same process for <code>age</code> as well. We see there is very clear evidence that a non-linear term is required for <code>age</code>.</p>
<div id="a05df53b" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:38.239488Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:38.239277Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:38.264822Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:38.264344Z&quot;}" data-execution_count="38">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>gam_0 <span class="op">=</span> LinearGAM(year_term <span class="op">+</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>                  f_gam(<span class="dv">2</span>, lam<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>gam_linear <span class="op">=</span> LinearGAM(l_gam(<span class="dv">0</span>, lam<span class="op">=</span><span class="dv">0</span>) <span class="op">+</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>                       year_term <span class="op">+</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>                       f_gam(<span class="dv">2</span>, lam<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>gam_0.fit(Xgam, y)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>gam_linear.fit(Xgam, y)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>anova_gam(gam_0, gam_linear, gam_full)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">deviance</th>
<th data-quarto-table-cell-role="th">df</th>
<th data-quarto-table-cell-role="th">deviance_diff</th>
<th data-quarto-table-cell-role="th">df_diff</th>
<th data-quarto-table-cell-role="th">F</th>
<th data-quarto-table-cell-role="th">pvalue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>3.975443e+06</td>
<td>2991.000589</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>3.850247e+06</td>
<td>2990.000704</td>
<td>125196.137317</td>
<td>0.999884</td>
<td>101.270106</td>
<td>1.681120e-07</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3.693143e+06</td>
<td>2987.007254</td>
<td>157103.978302</td>
<td>2.993450</td>
<td>42.447812</td>
<td>5.669414e-07</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>There is a (verbose) <code>summary()</code> method for the GAM fit.</p>
<div id="ee9db82c" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:38.267342Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:38.267144Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:38.271357Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:38.270406Z&quot;}" data-execution_count="39">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>gam_full.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>LinearGAM                                                                                                 
=============================================== ==========================================================
Distribution:                        NormalDist Effective DoF:                                     12.9927
Link Function:                     IdentityLink Log Likelihood:                                 -24117.907
Number of Samples:                         3000 AIC:                                            48263.7995
                                                AICc:                                             48263.94
                                                GCV:                                             1246.1129
                                                Scale:                                           1236.4024
                                                Pseudo R-Squared:                                   0.2928
==========================================================================================================
Feature Function                  Lambda               Rank         EDoF         P &gt; x        Sig. Code   
================================= ==================== ============ ============ ============ ============
s(0)                              [465.0491]           20           5.1          1.11e-16     ***         
s(1)                              [2.1564]             7            4.0          8.10e-03     **          
f(2)                              [0]                  5            4.0          1.11e-16     ***         
intercept                                              1            0.0          1.11e-16     ***         
==========================================================================================================
Significance codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

WARNING: Fitting splines and a linear function to a feature introduces a model identifiability problem
         which can cause p-values to appear significant when they are not.

WARNING: p-values calculated in this manner behave correctly for un-penalized models or models with
         known smoothing parameters, but when smoothing parameters have been estimated, the p-values
         are typically lower than they should be, meaning that the tests reject the null too readily.</code></pre>
</div>
</div>
<p>We can make predictions from <code>gam</code> objects, just like from <code>lm</code> objects, using the <code>predict()</code> method for the class <code>gam</code>. Here we make predictions on the training set.</p>
<div id="cf0a024d" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:38.274135Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:38.273728Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:38.283548Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:38.283095Z&quot;}" data-execution_count="40">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>Yhat <span class="op">=</span> gam_full.predict(Xgam)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In order to fit a logistic regression GAM, we use <code>LogisticGAM()</code> from <code>pygam</code>.</p>
<div id="0fe9f031" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:38.286193Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:38.285994Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:38.372533Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:38.372014Z&quot;}" data-execution_count="41">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>gam_logit <span class="op">=</span> LogisticGAM(age_term <span class="op">+</span> </span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>                        l_gam(<span class="dv">1</span>, lam<span class="op">=</span><span class="dv">0</span>) <span class="op">+</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>                        f_gam(<span class="dv">2</span>, lam<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>gam_logit.fit(Xgam, high_earn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>LogisticGAM(callbacks=[Deviance(), Diffs(), Accuracy()], 
   fit_intercept=True, max_iter=100, 
   terms=s(0) + l(1) + f(2) + intercept, tol=0.0001, verbose=False)</code></pre>
</div>
</div>
<div id="bdc73505" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:38.375490Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:38.375048Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:38.476110Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:38.475521Z&quot;}" data-execution_count="42">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> plot_gam(gam_logit, <span class="dv">2</span>)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Education'</span>)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Effect on wage'</span>)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Partial dependence of wage on education'</span>,</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>             fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(Wage[<span class="st">'education'</span>].cat.categories, fontsize<span class="op">=</span><span class="dv">8</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="07-nonlin-lab_files/figure-html/cell-43-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The model seems to be very flat, with especially high error bars for the first category. Let’s look at the data a bit more closely.</p>
<div id="44f57a30" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:38.478694Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:38.478494Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:38.491764Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:38.491357Z&quot;}" data-execution_count="43">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>pd.crosstab(Wage[<span class="st">'high_earn'</span>], Wage[<span class="st">'education'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">education</th>
<th data-quarto-table-cell-role="th">1. &lt; HS Grad</th>
<th data-quarto-table-cell-role="th">2. HS Grad</th>
<th data-quarto-table-cell-role="th">3. Some College</th>
<th data-quarto-table-cell-role="th">4. College Grad</th>
<th data-quarto-table-cell-role="th">5. Advanced Degree</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">high_earn</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">False</td>
<td>268</td>
<td>966</td>
<td>643</td>
<td>663</td>
<td>381</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">True</td>
<td>0</td>
<td>5</td>
<td>7</td>
<td>22</td>
<td>45</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We see that there are no high earners in the first category of education, meaning that the model will have a hard time fitting. We will fit a logistic regression GAM excluding all observations falling into this category. This provides more sensible results.</p>
<p>To do so, we could subset the model matrix, though this will not remove the column from <code>Xgam</code>. While we can deduce which column corresponds to this feature, for reproducibility’s sake we reform the model matrix on this smaller subset.</p>
<div id="3b061ffd" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:38.494311Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:38.494116Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:38.498822Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:38.498423Z&quot;}" data-execution_count="44">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>only_hs <span class="op">=</span> Wage[<span class="st">'education'</span>] <span class="op">==</span> <span class="st">'1. &lt; HS Grad'</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>Wage_ <span class="op">=</span> Wage.loc[<span class="op">~</span>only_hs]</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>Xgam_ <span class="op">=</span> np.column_stack([Wage_[<span class="st">'age'</span>],</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>                         Wage_[<span class="st">'year'</span>],</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>                         Wage_[<span class="st">'education'</span>].cat.codes<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>high_earn_ <span class="op">=</span> Wage_[<span class="st">'high_earn'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the second-to-last line above, we subtract one from the codes of the category, due to a bug in <code>pygam</code>. It just relabels the education values and hence has no effect on the fit.</p>
<p>We now fit the model.</p>
<div id="220e26ac" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:38.501236Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:38.501049Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:38.540965Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:38.540424Z&quot;}" data-execution_count="45">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>gam_logit_ <span class="op">=</span> LogisticGAM(age_term <span class="op">+</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>                         year_term <span class="op">+</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>                         f_gam(<span class="dv">2</span>, lam<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>gam_logit_.fit(Xgam_, high_earn_)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<pre><code>LogisticGAM(callbacks=[Deviance(), Diffs(), Accuracy()], 
   fit_intercept=True, max_iter=100, 
   terms=s(0) + s(1) + f(2) + intercept, tol=0.0001, verbose=False)</code></pre>
</div>
</div>
<p>Let’s look at the effect of <code>education</code>, <code>year</code> and <code>age</code> on high earner status now that we’ve removed those observations.</p>
<div id="94209d95" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:38.543510Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:38.543313Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:38.635421Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:38.634852Z&quot;}" data-execution_count="46">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> plot_gam(gam_logit_, <span class="dv">2</span>)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Education'</span>)</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Effect on wage'</span>)</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Partial dependence of high earner status on education'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(Wage[<span class="st">'education'</span>].cat.categories[<span class="dv">1</span>:],</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>                   fontsize<span class="op">=</span><span class="dv">8</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="07-nonlin-lab_files/figure-html/cell-47-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="b86a257f" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:38.637945Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:38.637732Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:38.738536Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:38.737576Z&quot;}" data-execution_count="47">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> plot_gam(gam_logit_, <span class="dv">1</span>)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Year'</span>)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Effect on wage'</span>)</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Partial dependence of high earner status on year'</span>,</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>             fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="07-nonlin-lab_files/figure-html/cell-48-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="075082df" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:38.741522Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:38.741306Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:38.853209Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:38.852962Z&quot;}" data-execution_count="48">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> plot_gam(gam_logit_, <span class="dv">0</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Age'</span>)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Effect on wage'</span>)</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Partial dependence of high earner status on age'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="07-nonlin-lab_files/figure-html/cell-49-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="local-regression" class="level2">
<h2 class="anchored" data-anchor-id="local-regression">Local Regression</h2>
<p>We illustrate the use of local regression using the <code>lowess()</code> function from <code>sm.nonparametric</code>. Some implementations of GAMs allow terms to be local regression operators; this is not the case in <code>pygam</code>.</p>
<p>Here we fit local linear regression models using spans of 0.2 and 0.5; that is, each neighborhood consists of 20% or 50% of the observations. As expected, using a span of 0.5 is smoother than 0.2.</p>
<div id="ecef97c8" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-06-04T23:19:38.854567Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-06-04T23:19:38.854494Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-06-04T23:19:38.953710Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-06-04T23:19:38.953441Z&quot;}" data-execution_count="49">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>lowess <span class="op">=</span> sm.nonparametric.lowess</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>ax.scatter(age, y, facecolor<span class="op">=</span><span class="st">'gray'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> span <span class="kw">in</span> [<span class="fl">0.2</span>, <span class="fl">0.5</span>]:</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    fitted <span class="op">=</span> lowess(y,</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>                    age,</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>                    frac<span class="op">=</span>span,</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>                    xvals<span class="op">=</span>age_grid)</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>    ax.plot(age_grid,</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>            fitted,</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">'</span><span class="sc">{:.1f}</span><span class="st">'</span>.<span class="bu">format</span>(span),</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>            linewidth<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Age'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Wage'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>ax.legend(title<span class="op">=</span><span class="st">'span'</span>, fontsize<span class="op">=</span><span class="dv">15</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="07-nonlin-lab_files/figure-html/cell-50-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>